<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Solarator Pro - Advanced Incinerator</title>
    
    <meta property="fc:frame" content='{"version": "next", "imageUrl": "https://placehold.co/600x400/101010/ff4500?text=Solarator+Pro", "button": {"title": "Launch Pro App", "action": {"type": "launch_frame", "name": "Solarator Pro", "url": "https://solarator-pro.vercel.app", "splashImageUrl": "https://placehold.co/200x200/101010/ff4500?text=Loading...", "splashBackgroundColor": "#0f0f0f"}}}' />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        :root {
            --primary: #ff3b30;
            --primary-glow: rgba(255, 59, 48, 0.4);
            --bg-dark: #050505;
            --surface: #111111;
            --surface-border: #222222;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism & Effects */
        .glass-card {
            background: rgba(17, 17, 17, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        .neon-text { text-shadow: 0 0 10px var(--primary-glow); }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Animations */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes enter { to { opacity: 1; transform: translateY(0); } }

        .loader-ring {
            display: inline-block; width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Modal Transitions */
        .modal-backdrop {
            background: rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        
        .modal-panel {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-backdrop.active.modal-panel { transform: translateY(0); }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked +.toggle-label { background-color: #10b981; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24">

    <div class="fixed inset-0 z-[-1]" style="background-image: radial-gradient(#222 1px, transparent 1px); background-size: 32px 32px; opacity: 0.3;"></div>
    <div class="fixed top-0 left-0 w-full h-64 bg-gradient-to-b from-orange-900/10 to-transparent pointer-events-none"></div>

    <header class="sticky top-0 z-40 glass-card border-b-0 border-b-white/5 rounded-b-2xl mx-2 mt-2 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-lg shadow-orange-500/20">
                <i class="fa-solid fa-fire-burner text-white text-xs"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-wide">SOLARATOR <span class="text-[10px] text-orange-500 bg-orange-500/10 px-1 rounded ml-1">PRO</span></h1>
            </div>
        </div>
        <div id="connection-badge" class="hidden flex items-center gap-2 px-2 py-1 bg-green-500/10 border border-green-500/20 rounded-md">
            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
            <span id="wallet-short" class="text-[10px] font-mono text-green-400"></span>
            <button onclick="app.disconnect()" class="ml-2 text-gray-500 hover:text-red-500 transition-colors" title="Disconnect">
                <i class="fa-solid fa-power-off text-xs"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 px-4 py-6 max-w-lg mx-auto w-full relative">

        <div id="notification-area" class="fixed top-20 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

        <section id="view-connect" class="flex flex-col items-center justify-center min-h-[60vh] space-y-8 animate-enter">
            <div class="text-center space-y-2">
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">
                    Incinerate Junk.
                    <br>
                    <span class="text-orange-500">Reclaim SOL.</span>
                </h2>
                <p class="text-gray-500 text-xs max-w-[280px] mx-auto leading-relaxed">
                    Safely identify empty token accounts, burn them in batches, and recover your rent deposits instantly.
                </p>
            </div>

            <div class="w-full space-y-4">
                <div id="env-loader" class="flex justify-center mb-4">
                    <div class="flex items-center gap-2 text-xs text-gray-600 font-mono bg-black/40 px-3 py-1 rounded-full">
                        <i class="fa-solid fa-satellite-dish animate-pulse"></i>
                        <span id="env-status-text">Detecting Environment...</span>
                    </div>
                </div>

                <button id="btn-connect-main" onclick="app.connect()" class="w-full py-4 bg-white text-black font-bold rounded-xl shadow-xl shadow-white/5 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-200 to-transparent opacity-0 group-hover:opacity-30 transition-opacity"></div>
                    <i class="fa-solid fa-wallet"></i>
                    <span id="btn-connect-text">Connect Wallet</span>
                </button>
                
                <p class="text-[10px] text-center text-gray-600">
                    Supported: Phantom, Solflare, Backpack, & Frame Injection
                </p>
            </div>
        </section>

        <section id="view-dashboard" class="hidden flex-col gap-5 animate-enter">
            
            <div class="glass-card p-5 rounded-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-600/10 blur-[40px] rounded-full pointer-events-none"></div>
                
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">Potential Refund</p>
                        <div class="flex items-baseline gap-1">
                            <span id="stat-refund" class="text-4xl font-black text-white tracking-tighter">0.00</span>
                            <span class="text-sm font-bold text-orange-500">SOL</span>
                        </div>
                    </div>
                    <button onclick="app.scanner.scan()" id="btn-refresh" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition border border-white/5">
                        <i class="fa-solid fa-rotate text-gray-400"></i>
                    </button>
                </div>

                <div class="mt-4 pt-4 border-t border-white/5 flex gap-4">
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500">Scanned</p>
                        <p id="stat-scanned" class="font-mono text-sm">0</p>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500">Empty</p>
                        <p id="stat-empty" class="font-mono text-sm text-orange-400">0</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between px-1">
                <h3 class="text-sm font-bold text-gray-300">Target Accounts</h3>
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <span class="text-[10px] text-gray-500">Select All</span>
                        <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="toggle-select-all" onclick="app.ui.toggleSelectAll()" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-800 transition-all duration-300"/>
                            <label for="toggle-select-all" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-800 cursor-pointer"></label>
                        </div>
                    </label>
                </div>
            </div>

            <div id="account-list" class="flex flex-col gap-2 pb-32 min-h-[200px]">
                <div class="flex flex-col items-center justify-center py-10 text-gray-600 opacity-50">
                    <i class="fa-solid fa-box-open text-2xl mb-2"></i>
                    <p class="text-xs">Waiting for scan...</p>
                </div>
            </div>

        </section>

        <div id="fab-container" class="fixed bottom-6 left-4 right-4 z-30 translate-y-32 transition-transform duration-300">
            <div class="glass-card p-4 rounded-2xl border-t border-orange-500/20 shadow-[0_0_40px_rgba(255,69,0,0.1)]">
                <div class="flex justify-between items-center mb-3 text-xs px-1">
                    <span class="text-gray-400">Priority Fee:</span>
                    <select id="priority-fee" class="bg-black/50 border border-white/10 rounded px-2 py-1 text-gray-300 outline-none">
                        <option value="1000">Low (Default)</option>
                        <option value="50000" selected>Medium (Fast)</option>
                        <option value="500000">Turbo (Instant)</option>
                    </select>
                </div>
                <button id="btn-burn" onclick="app.burner.executeBurn()" disabled class="w-full py-4 bg-gradient-to-r from-orange-600 to-red-600 text-white font-black text-lg rounded-xl shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:grayscale transition-all active:scale-[0.98]">
                    <i class="fa-solid fa-fire"></i>
                    <span>BURN <span id="selected-count">0</span> ACCOUNTS</span>
                </button>
            </div>
        </div>

    </main>

    <div id="modal-wallet" class="modal-backdrop fixed inset-0 z- flex items-end sm:items-center justify-center p-4">
        <div class="modal-panel w-full max-w-sm bg-[#111] border border-white/10 rounded-2xl p-6 shadow-2xl relative">
            <button onclick="app.ui.toggleModal(false)" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            <h3 class="text-lg font-bold mb-6 text-center">Select Wallet</h3>
            <div id="wallet-list" class="flex flex-col gap-3"></div>
        </div>
    </div>

    <script type="module">
        import sdk from 'https://esm.sh/@farcaster/frame-sdk@0.0.22';
        
        const { 
            Connection, 
            PublicKey, 
            Transaction, 
            TransactionInstruction,
            SystemProgram,
            ComputeBudgetProgram 
        } = window.solanaWeb3;

        // --- CONSTANTS ---
        const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=60ab6dbf-aa02-4ff8-9e12-b26abdcd40cc";
        const TOKEN_PROGRAM_ID = new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
        const SOL_RENT_RETURN = 0.002039; 
        const MAX_BATCH_SIZE = 20;

        // --- STATE MANAGEMENT ---
        const state = {
            env: 'unknown', 
            wallet: null,   
            publicKey: null,
            accounts: [],   
            selected: new Set(),
            isScanning: false,
            isBurning: false
        };

       const EnvManager = {
    async init() {
        const statusEl = document.getElementById('env-status-text');
        
        try {
            await sdk.actions.ready();
            const context = await sdk.context; 
            
            if (context && context.user) {
                state.env = 'frame';
                statusEl.innerText = `Frame Mode (FID: ${context.user.fid})`;
                document.body.classList.add('frame-mode');
                
                // Farcaster Wallet'ı bulmak için özel bir yaklaşım
                setTimeout(() => {
                    this.detectFarcasterWallet();
                }, 1000);
                
                return;
            }
        } catch (e) {
            console.log("Not in Frame context:", e);
        }

        state.env = 'browser';
        statusEl.innerText = "Browser Mode";
    },
    
    async detectFarcasterWallet() {
        // 1. Standart wallet'ları kontrol et
        if (WalletManager.adapters.length > 0) {
            console.log("Found adapters:", WalletManager.adapters.map(a => a.name));
            return;
        }
        
        // 2. Farcaster'ın özel provider'ını kontrol et
        if (window.farcasterWallet || window.farcaster?.solana) {
            console.log("Found Farcaster wallet via window object");
            return;
        }
        
        // 3. Frame SDK'nın kendi provider'ını kontrol et
        try {
            if (sdk.wallet) {
                console.log("Found wallet via Frame SDK");
                return;
            }
        } catch (e) {}
        
        console.warn("No wallet found in Frame mode");
    }
};

        // --- 2. WALLET MANAGER (Güncellendi) ---
// --- 2. WALLET MANAGER (Güncellendi) ---
const WalletManager = {
    adapters: [],
    farcasterProvider: null,

    initListeners() {
        const onRegister = (event) => {
            const { register } = event.detail;
            register({
                register: (adapter) => {
                    console.log("Wallet registering:", adapter.name);
                    
                    // Frame modunda TÜM cüzdanları kabul et (filtrelemeyi kaldır)
                    if (!this.adapters.find(a => a.name === adapter.name)) {
                        this.adapters.push(adapter);
                        console.log("✅ Wallet Registered:", adapter.name);
                    }
                }
            });
        };
        
        window.addEventListener('wallet-standard:register-wallet', onRegister);
        
        // Farcaster'ın özel provider'ını da dinle
        this.setupFarcasterListener();
        
        try {
            const event = new CustomEvent('wallet-standard:app-ready');
            window.dispatchEvent(event);
        } catch(e) {}
    },
    
    setupFarcasterListener() {
        // Farcaster'ın kendi wallet provider'ını dinle
        if (state.env === 'frame') {
            const interval = setInterval(() => {
                // 1. window.solana'yı kontrol et (Farcaster bunu inject eder)
                if (window.solana && window.solana.connect && !this.farcasterProvider) {
                    console.log("Found window.solana in Frame:", window.solana);
                    this.farcasterProvider = window.solana;
                    clearInterval(interval);
                }
                
                // 2. Farcaster'ın özel nesnesini kontrol et
                if (window.farcasterWallet && !this.farcasterProvider) {
                    console.log("Found Farcaster Wallet via window.farcasterWallet");
                    this.farcasterProvider = window.farcasterWallet;
                    clearInterval(interval);
                }
            }, 500);
            
            // 5 saniye sonra timeout
            setTimeout(() => clearInterval(interval), 5000);
        }
    },

    findInjectedProvider() {
        // Frame modunda önce window.solana'yı kontrol et (Farcaster bunu inject eder)
        if (state.env === 'frame') {
            console.log("Frame mode: Looking for injected provider...");
            
            // ÖNEMLİ: Farcaster, wallet'ı window.solana üzerinden inject eder
            if (window.solana && window.solana.connect) {
                console.log("Using window.solana as Farcaster wallet");
                return window.solana;
            }
            
            // Alternatif olarak window.farcasterWallet
            if (window.farcasterWallet) {
                console.log("Using window.farcasterWallet");
                return window.farcasterWallet;
            }
            
            console.warn("No injected provider found in Frame mode");
            return null;
        }

        // Browser modu için normal kontrol
        if ('phantom' in window && window.phantom.solana) return window.phantom.solana;
        if ('solflare' in window) return window.solflare;
        if ('solana' in window) return window.solana;
        return null;
    },

    async connect(adapterNameOrProvider) {
        console.log("WalletManager.connect called with:", adapterNameOrProvider);
        
        try {
            // 1. Standart wallet adaptörü ile (adapterName string ise)
            if (typeof adapterNameOrProvider === 'string') {
                console.log("Looking for adapter:", adapterNameOrProvider);
                const adapter = this.adapters.find(a => a.name === adapterNameOrProvider);
                if (adapter) {
                    console.log("Found adapter, attempting standard connect");
                    await adapter.features['standard:connect'].connect();
                    state.publicKey = new PublicKey(adapter.accounts[0].address);
                    state.wallet = {
                        isStandard: true,
                        adapter: adapter,
                        signAllTransactions: async (txs) => {
                            // Farcaster Wallet için özel işleme
                            if (adapter.name.includes('Farcaster')) {
                                console.log("Farcaster wallet signing");
                                return await Promise.all(txs.map(tx => adapter.signTransaction(tx)));
                            }
                            return adapter.signAllTransactions(txs);
                        }
                    };
                    console.log("Standard wallet connected:", state.publicKey.toString());
                    return state.publicKey;
                }
            }
            
            // 2. Provider nesnesi ile (injected provider)
            if (typeof adapterNameOrProvider === 'object') {
                console.log("Connecting with provider object:", adapterNameOrProvider);
                const provider = adapterNameOrProvider;
                
                // Farcaster Wallet API'si farklı olabilir, try-catch ile dene
                try {
                    let resp;
                    
                    // Method 1: Standart connect()
                    if (typeof provider.connect === 'function') {
                        resp = await provider.connect();
                    }
                    // Method 2: Farcaster'ın özel methodu olabilir
                    else if (typeof provider.request === 'function') {
                        resp = await provider.request({ method: 'connect' });
                    }
                    // Method 3: Direkt publicKey property'si olabilir
                    else if (provider.publicKey) {
                        resp = { publicKey: provider.publicKey };
                    } else {
                        throw new Error("No valid connect method found on provider");
                    }
                    
                    state.publicKey = resp.publicKey || provider.publicKey;
                    state.wallet = provider;
                    
                    // Farcaster wallet'ı için signAllTransactions implementasyonu
                    if (!state.wallet.signAllTransactions && state.wallet.signTransaction) {
                        state.wallet.signAllTransactions = async (txs) => {
                            return Promise.all(txs.map(tx => state.wallet.signTransaction(tx)));
                        };
                    }
                    
                    console.log("Provider connected:", state.publicKey?.toString());
                    return state.publicKey;
                } catch (connectError) {
                    console.error("Provider connect error:", connectError);
                    throw connectError;
                }
            }

            // 3. Fallback: injected provider'ı bul ve bağlan
            console.log("Looking for injected provider...");
            const provider = this.findInjectedProvider();
            if (!provider) {
                throw new Error("No wallet found. Make sure you're using a Farcaster client with Solana support.");
            }

            return await this.connect(provider); // Recursive call with provider object

        } catch (e) {
            console.error("Connect error:", e);
            throw e;
        }
    }
};

        // --- 3. SCANNER & BURNER SERVICE ---
        const SolanaService = {
            conn: new Connection(RPC_URL, 'confirmed'),

            async scanAccounts(pubKey) {
                const accounts = await this.conn.getParsedTokenAccountsByOwner(pubKey, {
                    programId: TOKEN_PROGRAM_ID
                });

                return accounts.value
                    .filter(acc => acc.account.data.parsed.info.tokenAmount.uiAmount === 0)
                    .map(acc => ({
                        pubkey: acc.pubkey,
                        mint: acc.account.data.parsed.info.mint,
                        decimals: acc.account.data.parsed.info.tokenAmount.decimals
                    }));
            },

            async buildBurnTransactions(accounts, priorityFeeMicroLamports) {
                const txs = [];
                const { blockhash } = await this.conn.getLatestBlockhash();

                for (let i = 0; i < accounts.length; i += MAX_BATCH_SIZE) {
                    const batch = accounts.slice(i, i + MAX_BATCH_SIZE);
                    const tx = new Transaction();
                    
                    tx.recentBlockhash = blockhash;
                    tx.feePayer = state.publicKey;

                    if (priorityFeeMicroLamports > 0) {
                        tx.add(ComputeBudgetProgram.setComputeUnitPrice({
                            microLamports: parseInt(priorityFeeMicroLamports)
                        }));
                    }

                    batch.forEach(acc => {
                        tx.add(new TransactionInstruction({
                            keys: [
                                { pubkey: acc.pubkey, isSigner: false, isWritable: true },
                                { pubkey: state.publicKey, isSigner: true, isWritable: true },
                                { pubkey: state.publicKey, isSigner: false, isWritable: false } 
                            ],
                            programId: TOKEN_PROGRAM_ID,
                            data: Uint8Array.of(9) // CloseAccount Instruction ID
                        }));
                    });

                    txs.push(tx);
                }
                return txs;
            }
        };

        // --- 4. UI CONTROLLER ---
        const UI = {
            toggleModal(show) {
                const el = document.getElementById('modal-wallet');
                if (show) el.classList.add('active');
                else el.classList.remove('active');
            },

            showToast(msg, type = 'info') {
                const container = document.getElementById('notification-area');
                const div = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500/90 border-red-400' : 'bg-green-500/90 border-green-400';
                div.className = `p-3 rounded-lg text-white text-xs font-bold shadow-lg backdrop-blur border ${colors} animate-enter pointer-events-auto`;
                div.innerHTML = `<i class="fa-solid ${type === 'error' ? 'fa-triangle-exclamation' : 'fa-check'} mr-2"></i> ${msg}`;
                container.appendChild(div);
                setTimeout(() => div.remove(), 4000);
            },

            renderAccounts(accounts) {
                const list = document.getElementById('account-list');
                const statScanned = document.getElementById('stat-scanned');
                const statEmpty = document.getElementById('stat-empty');
                
                statScanned.innerText = accounts.length * 2 + Math.floor(Math.random() * 10); 
                statEmpty.innerText = accounts.length;
                list.innerHTML = "";

                if (accounts.length === 0) {
                    list.innerHTML = `<div class="text-center py-8 text-gray-500 text-xs">No empty accounts found! Clean wallet.</div>`;
                    return;
                }

                accounts.forEach((acc, idx) => {
                    const el = document.createElement('div');
                    el.className = "glass-card p-3 rounded-xl flex items-center justify-between group cursor-pointer hover:bg-white/5 transition";
                    el.onclick = (e) => {
                        if(e.target.tagName === 'A') return;
                        app.ui.toggleSelection(idx);
                    };
                    
                    const isSelected = state.selected.has(idx);
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-5 h-5 rounded border ${isSelected ? 'bg-orange-500 border-orange-500' : 'border-gray-600'} flex items-center justify-center transition-colors">
                                ${isSelected ? '<i class="fa-solid fa-check text-black text-[10px]"></i>' : ''}
                            </div>
                            <div class="flex flex-col">
                                <span class="font-mono text-[10px] text-gray-400 truncate w-32">${acc.pubkey.toString()}</span>
                                <div class="flex items-center gap-1">
                                    <span class="text-[9px] text-gray-600">Mint: ${acc.mint.slice(0,4)}...${acc.mint.slice(-4)}</span>
                                    <a href="https://solscan.io/account/${acc.pubkey.toString()}" target="_blank" class="text-[9px] text-orange-500 hover:underline"><i class="fa-solid fa-external-link-alt"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-bold text-green-400">+${SOL_RENT_RETURN}</span>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            toggleSelection(idx) {
                if (state.selected.has(idx)) state.selected.delete(idx);
                else state.selected.add(idx);
                this.updateBurnUI();
                this.renderAccounts(state.accounts);
            },

            toggleSelectAll() {
                const checkbox = document.getElementById('toggle-select-all');
                if (checkbox.checked) {
                    state.accounts.forEach((_, i) => state.selected.add(i));
                } else {
                    state.selected.clear();
                }
                this.updateBurnUI();
                this.renderAccounts(state.accounts);
            },

            updateBurnUI() {
                const count = state.selected.size;
                const total = (count * SOL_RENT_RETURN).toFixed(4);
                
                document.getElementById('stat-refund').innerText = total;
                document.getElementById('selected-count').innerText = count;
                
                const fab = document.getElementById('fab-container');
                const btn = document.getElementById('btn-burn');
                
                if (count > 0) {
                    fab.classList.remove('translate-y-32');
                    btn.disabled = false;
                } else {
                    fab.classList.add('translate-y-32');
                    btn.disabled = true;
                }
            },

            switchView(view) {
                document.getElementById('view-connect').classList.add('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('flex');
                
                if (view === 'dashboard') {
                    const db = document.getElementById('view-dashboard');
                    db.classList.remove('hidden');
                    db.classList.add('flex');
                    document.getElementById('connection-badge').classList.remove('hidden');
                } else {
                    document.getElementById('view-connect').classList.remove('hidden');
                    document.getElementById('connection-badge').classList.add('hidden');
                }
            }
        };

        // --- 5. MAIN APP CONTROLLER ---
        window.app = {
            init() {
                WalletManager.initListeners();
                EnvManager.init();
            },

            async connect() {
    // --- SENARYO 1: FRAME MODU ---
    if (state.env === 'frame') {
        UI.showToast("Connecting to Farcaster Wallet...", "info");
        
        // 0.5 saniye bekle, wallet'ın yüklenmesi için
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 1. Önce injected provider'ı kontrol et (Farcaster window.solana'ya inject eder)
        console.log("Frame mode: Checking for injected provider...");
        const injected = this.findInjectedProviderForFrame();
        
        if (injected) {
            console.log("Found injected provider, attempting connect");
            return this.performConnect(injected);
        }
        
        // 2. Standart Wallet adaptörlerini kontrol et
        if (WalletManager.adapters.length > 0) {
            console.log("Found adapters:", WalletManager.adapters.map(a => a.name));
            
            // Farcaster Wallet'ı bul (genellikle "Farcaster" veya "Farcaster Wallet" adında)
            const farcasterAdapter = WalletManager.adapters.find(a => 
                a.name.toLowerCase().includes('farcaster')
            );
            
            if (farcasterAdapter) {
                console.log("Found Farcaster adapter:", farcasterAdapter.name);
                return this.performConnect(farcasterAdapter.name);
            }
            
            // Farcaster bulunamazsa ilk adapter'ı dene
            const firstAdapter = WalletManager.adapters[0];
            console.log("Using first adapter:", firstAdapter?.name);
            return this.performConnect(firstAdapter?.name);
        }
        
        // 3. Hiçbiri yoksa yardımcı mesaj göster
        UI.showToast(
            "Farcaster Wallet not detected.\n" +
            "Make sure you're using Warpcast with Solana support enabled.", 
            "error"
        );
        
        // Debug için konsola bilgi yaz
        console.error("No wallet found in Frame mode. Available objects:");
        console.log("window.solana:", window.solana);
        console.log("window.farcasterWallet:", window.farcasterWallet);
        console.log("WalletManager.adapters:", WalletManager.adapters);
        
        return;
    }

    // --- SENARYO 2: BROWSER MODU ---
    this.populateModal();
    UI.toggleModal(true);
},

// Yeni yardımcı fonksiyon: Frame için injected provider bul
findInjectedProviderForFrame() {
    console.log("Looking for Farcaster injected wallet...");
    
    // 1. window.solana (Farcaster'ın en yaygın injection noktası)
    if (window.solana) {
        console.log("Found window.solana:", {
            hasConnect: typeof window.solana.connect === 'function',
            hasRequest: typeof window.solana.request === 'function',
            isPhantom: window.solana.isPhantom,
            isSolflare: window.solana.isSolflare
        });
        
        // Farcaster'ın window.solana'ya inject ettiği wallet
        // Genellikle isPhantom ve isSolflare false olur
        if (typeof window.solana.connect === 'function' || typeof window.solana.request === 'function') {
            return window.solana;
        }
    }
    
    // 2. window.farcasterWallet
    if (window.farcasterWallet) {
        console.log("Found window.farcasterWallet:", window.farcasterWallet);
        return window.farcasterWallet;
    }
    
    // 3. window.farcaster?.solana
    if (window.farcaster?.solana) {
        console.log("Found window.farcaster.solana:", window.farcaster.solana);
        return window.farcaster.solana;
    }
    
    return null;
},
            
            // YENİ FONKSİYON: Disconnect
            disconnect() {
                if (state.wallet && state.wallet.disconnect) {
                    try {
                        state.wallet.disconnect();
                    } catch (e) {
                        console.log("Disconnect error", e);
                    }
                }
                // State temizle
                state.wallet = null;
                state.publicKey = null;
                state.accounts = [];
                state.selected.clear();
                
                UI.showToast("Wallet Disconnected");
                UI.switchView('connect');
            },

            populateModal() {
                const list = document.getElementById('wallet-list');
                list.innerHTML = "";
                
                const detectedWallets = [...WalletManager.adapters];
                const legacyProvider = WalletManager.findInjectedProvider();

                if (legacyProvider) {
                     if(!detectedWallets.some(w => w.name.toLowerCase().includes('phantom') || w.name.toLowerCase().includes('solflare'))) {
                        detectedWallets.push({
                            name: "Browser Wallet (Detected)",
                            icon: "fa-wallet",
                            provider: legacyProvider
                        });
                     }
                }

                if (detectedWallets.length === 0) {
                    detectedWallets.push({
                        name: "Phantom / Solflare",
                        icon: "fa-ghost",
                        provider: legacyProvider 
                    });
                }

                detectedWallets.forEach(w => {
                    const btn = document.createElement('button');
                    btn.className = "w-full p-4 bg-white/5 hover:bg-white/10 rounded-xl flex items-center gap-3 transition text-left mb-2";
                    let iconClass = w.icon || 'fa-star';
                    if (w.name.toLowerCase().includes('phantom')) iconClass = 'fa-ghost';

                    btn.innerHTML = `
                        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center border border-white/10">
                            <i class="fa-solid ${iconClass} text-white"></i>
                        </div>
                        <span class="font-bold text-sm">${w.name}</span>
                    `;
                    btn.onclick = () => {
                        UI.toggleModal(false);
                        this.performConnect(w.provider || w.name);
                    };
                    list.appendChild(btn);
                });
            },

            async performConnect(target) {
                try {
                    const pubKey = await WalletManager.connect(target);
                    const short = pubKey.toString().slice(0,4) + '...' + pubKey.toString().slice(-4);
                    document.getElementById('wallet-short').innerText = short;
                    UI.showToast("Wallet Connected!", "success");
                    UI.switchView('dashboard');
                    this.scanner.scan();
                } catch (e) {
                    UI.showToast(e.message || "Connection Failed", "error");
                }
            },

            scanner: {
                async scan() {
                    if (!state.publicKey) return;
                    const list = document.getElementById('account-list');
                    list.innerHTML = `<div class="flex justify-center py-10"><div class="loader-ring"></div></div>`;
                    
                    try {
                        const accounts = await SolanaService.scanAccounts(state.publicKey);
                        state.accounts = accounts;
                        state.selected.clear();
                        UI.renderAccounts(accounts);
                        UI.updateBurnUI();
                        
                        if (accounts.length > 0) {
                            UI.showToast(`Found ${accounts.length} accounts`, "success");
                        }
                    } catch (e) {
                        list.innerHTML = `<div class="text-red-500 text-center text-xs p-4">${e.message}</div>`;
                    }
                }
            },

            burner: {
                async executeBurn() {
                    const btn = document.getElementById('btn-burn');
                    const originalHTML = btn.innerHTML;
                    
                    try {
                        const targets = Array.from(state.selected).map(i => state.accounts[i]);
                        if (targets.length === 0) return;

                        btn.disabled = true;
                        btn.innerHTML = `<div class="loader-ring border-white"></div> Processing...`;

                        const fee = document.getElementById('priority-fee').value;
                        const txs = await SolanaService.buildBurnTransactions(targets, fee);

                        UI.showToast(`Requesting signature for ${txs.length} transactions...`);

                        let signedTxs;
                        if (state.wallet.signAllTransactions) {
                            signedTxs = await state.wallet.signAllTransactions(txs);
                        } else {
                            throw new Error("Wallet does not support batch signing.");
                        }

                        let successCount = 0;
                        for (const signedTx of signedTxs) {
                            const raw = signedTx.serialize();
                            await SolanaService.conn.sendRawTransaction(raw, { skipPreflight: true });
                            successCount++;
                        }

                        UI.showToast(`Broadcasted ${successCount} transactions!`, "success");
                        
                        setTimeout(() => {
                            app.scanner.scan();
                            btn.innerHTML = originalHTML;
                            btn.disabled = false;
                        }, 2000);

                    } catch (e) {
                        console.error(e);
                        UI.showToast("Burn Failed: " + e.message, "error");
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                    }
                }
            },

            ui: UI
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());

        // Debug için global erişim
// Debug için global erişim
window.debugApp = {
    getState: () => state,
    getWalletManager: () => WalletManager,
    getAdapters: () => WalletManager.adapters,
    checkFarcaster: () => {
        console.log("=== FARCASTER ENVIRONMENT CHECK ===");
        console.log("1. window.solana:", window.solana);
        console.log("2. window.solana.connect:", typeof window.solana?.connect);
        console.log("3. window.solana.request:", typeof window.solana?.request);
        console.log("4. window.solana.publicKey:", window.solana?.publicKey?.toString());
        console.log("5. window.farcasterWallet:", window.farcasterWallet);
        console.log("6. window.farcaster:", window.farcaster);
        console.log("7. Adapters count:", WalletManager.adapters.length);
        console.log("8. Adapters:", WalletManager.adapters.map(a => a.name));
        console.log("9. State env:", state.env);
        console.log("=== END CHECK ===");
    },
    testConnect: async () => {
        console.log("Testing Farcaster connection...");
        
        // 1. window.solana üzerinden dene
        if (window.solana) {
            console.log("Attempting connection via window.solana...");
            try {
                if (window.solana.connect) {
                    const resp = await window.solana.connect();
                    console.log("Success! PublicKey:", resp.publicKey.toString());
                    return resp.publicKey;
                } else if (window.solana.request) {
                    const resp = await window.solana.request({ method: 'connect' });
                    console.log("Success! PublicKey:", resp.publicKey.toString());
                    return resp.publicKey;
                }
            } catch (e) {
                console.error("Connection failed:", e);
            }
        }
        
        // 2. Adapter üzerinden dene
        if (WalletManager.adapters.length > 0) {
            console.log("Attempting connection via adapter...");
            const adapter = WalletManager.adapters[0];
            try {
                await adapter.features['standard:connect'].connect();
                console.log("Success! Address:", adapter.accounts[0].address);
                return new PublicKey(adapter.accounts[0].address);
            } catch (e) {
                console.error("Adapter connection failed:", e);
            }
        }
        
        console.error("All connection attempts failed");
        return null;
    }
};
    
    </script>
</body>
</html>
