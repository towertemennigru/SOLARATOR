<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farcaster Solana Frame v2 (Vanilla)</title>
    
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://placehold.co/600x400/9945FF/ffffff?text=Solana+Frame+v2" />
    <meta property="fc:frame:button:1" content="Cüzdanı Bağla" />
    <meta property="fc:frame:post_url" content="https://my-frame-server.com/api/frame" />
    
    <style>
        /* Farcaster Dark Mode Estetiğine Uygun Renk Paleti */
        :root {
            --bg-color: #0f172a; /* Koyu Lacivert Arka Plan */
            --text-color: #f8fafc; /* Kırık Beyaz Metin */
            --primary-color: #9945FF; /* Solana Moru */
            --secondary-color: #14F195; /* Solana Yeşili */
            --error-color: #ef4444; /* Hata Kırmızısı */
            --surface-color: rgba(255, 255, 255, 0.05); /* Yarı Saydam Kart Rengi */
        }

        /* Mobil Öncelikli Reset ve Temel Stiller */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 16px; /* Mobilde kenar boşluğu */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            -webkit-font-smoothing: antialiased; /* Font yumuşatma */
        }

        /* Kart Yapısı: İçerik Kapsayıcısı */
       .container {
            width: 100%;
            max-width: 420px; /* Warpcast mobil görünüm genişliği */
            background: var(--surface-color);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); /* Derinlik hissi */
            backdrop-filter: blur(8px); /* Buzlu cam efekti */
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; /* Gradient Başlık */
        }
        
        p {
            color: #94a3b8;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        /* İnteraktif Bileşenler: Butonlar */
       .btn {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 12px;
            transition: transform 0.1s ease, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

       .btn:active { transform: scale(0.97); } /* Tıklama efekti */
       .btn:hover { filter: brightness(1.1); }
       .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

       .btn-secondary {
            background: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }

       .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        /* Yardımcı Sınıflar */
       .hidden { display: none!important; }
       .break-all { word-break: break-all; }
        
        #status {
            margin-top: 20px;
            font-size: 0.85rem;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            min-height: 20px;
            opacity: 0; /* Başlangıçta görünmez */
            transition: opacity 0.3s;
        }
        #status.visible { opacity: 1; }

        /* Cüzdan Adresi Gösterimi */
        code {
            font-family: 'Fira Code', monospace;
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            color: var(--secondary-color);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Solana Bağlantı Portalı</h1>
        
        <div id="loading-state">
            <p>Sistem Başlatılıyor...</p>
        </div>

        <div id="connect-view" class="hidden">
            <p>Farcaster kimliğiniz ile Solana ekosistemine güvenli giriş yapın.</p>
            <button id="connect-btn" class="btn">
                <span>Cüzdanı Bağla (Phantom/Solflare)</span>
            </button>
        </div>

        <div id="wallet-view" class="hidden">
            <p>Cüzdan Başarıyla Bağlandı</p>
            <div style="margin-bottom: 20px;">
                <code id="pubkey-display">...</code>
            </div>
            
            <div style="text-align: left; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <small style="color: #64748b; display: block; margin-bottom: 4px;">Kullanıcı Bağlamı (Context)</small>
                <span id="user-context" style="color: #e2e8f0; font-weight: 500;">Bilinmiyor</span>
            </div>

            <button id="sign-msg-btn" class="btn btn-secondary">Kimlik Doğrulama İmzası At</button>
            <button id="disconnect-btn" class="btn btn-danger">Bağlantıyı Kes</button>
        </div>

        <div id="status"></div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. Kütüphane İçe Aktarımı (CDN üzerinden ES Modules)
        // ---------------------------------------------------------
        
        // Solana Web3.js: Blokzincir etkileşimi için ana kütüphane.
        // Versiyon 1.91.8 stabil ve yaygın kullanılan bir sürümdür.
        import { 
            Connection, 
            PublicKey, 
            clusterApiUrl 
        } from 'https://esm.sh/@solana/web3.js@1.91.8';
        
        // Farcaster Frame SDK: Frame v2 özelliklerini yönetir.
        // Alpha sürüm olduğu için güncellemeler sık olabilir.
        import sdk from 'https://esm.sh/@farcaster/frame-sdk@0.0.22';

        // ---------------------------------------------------------
        // 2. DOM Referansları ve Durum Yönetimi
        // ---------------------------------------------------------
        
        const views = {
            loading: document.getElementById('loading-state'),
            connect: document.getElementById('connect-view'),
            wallet: document.getElementById('wallet-view')
        };
        
        const els = {
            connectBtn: document.getElementById('connect-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            signMsgBtn: document.getElementById('sign-msg-btn'),
            pubkeyDisplay: document.getElementById('pubkey-display'),
            userContext: document.getElementById('user-context'),
            status: document.getElementById('status')
        };

        // Uygulama Durumu (State)
        let state = {
            provider: null,      // Seçilen Cüzdan Sağlayıcısı (Phantom/Solflare objesi)
            publicKey: null,     // Bağlı cüzdanın açık anahtarı
            isConnected: false,
            farcasterUser: null  // SDK'dan gelen kullanıcı verisi
        };

        // ---------------------------------------------------------
        // 3. Yardımcı Fonksiyonlar (Utils)
        // ---------------------------------------------------------

        // Kullanıcıya bildirim gösterme fonksiyonu
        function showStatus(msg, type = 'info') {
            els.status.innerText = msg;
            els.status.className = 'visible';
            els.status.style.color = type === 'error'? 'var(--error-color)' : 
                                     type === 'success'? 'var(--secondary-color)' : '#94a3b8';
            
            // 3 saniye sonra mesajı gizle
            setTimeout(() => {
                els.status.className = '';
            }, 3000);
        }

        // Görünüm değiştirme (Router benzeri yapı)
        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        // Adres kısaltma (örn: 8x...4k2)
        function truncateAddress(addr) {
            if (!addr) return '';
            return `${addr.slice(0, 6)}...${addr.slice(-6)}`;
        }

        // ---------------------------------------------------------
        // 4. Solana Cüzdan Tespit Mantığı (Provider Discovery)
        // ---------------------------------------------------------
        
        /**
         * Tarayıcıdaki mevcut cüzdanları tarar ve en uygun olanı döndürür.
         * Bu fonksiyon, "Race Condition"ı önlemek için çağrıldığı andaki window durumunu kontrol eder.
         */
        function getSolanaProvider() {
            // 1. Phantom Kontrolü (Öncelikli)
            if ('phantom' in window) {
                const provider = window.phantom?.solana;
                if (provider?.isPhantom) return provider;
            }

            // 2. Solflare Kontrolü
            if ('solflare' in window) {
                return window.solflare;
            }

            // 3. Genel "window.solana" Kontrolü (Legacy)
            if ('solana' in window) {
                const provider = window.solana;
                if (provider.isPhantom |

| provider.isSolflare) return provider;
            }

            return null;
        }

        // ---------------------------------------------------------
        // 5. Ana İş Mantığı (Business Logic)
        // ---------------------------------------------------------

        // Cüzdan Bağlama Süreci
        async function connectWallet() {
            try {
                const provider = getSolanaProvider();

                if (!provider) {
                    // Cüzdan yoksa, mobil veya masaüstü durumuna göre yönlendirme
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    if (isMobile) {
                        showStatus("Cüzdan bulunamadı. Phantom uygulamasına yönlendiriliyor...", "error");
                        // Deep Link ile Phantom açma (Universal Link)
                        window.location.href = `https://phantom.app/ul/browse/${encodeURIComponent(window.location.href)}?ref=${encodeURIComponent(window.location.href)}`;
                    } else {
                        window.open("https://phantom.app/", "_blank");
                        showStatus("Lütfen Phantom veya Solflare cüzdanı yükleyin.", "error");
                    }
                    return;
                }

                showStatus("Cüzdan onayı bekleniyor...");
                
                // Cüzdan penceresini aç
                const resp = await provider.connect();
                
                // Başarılı bağlantı sonrası durum güncellemesi
                state.provider = provider;
                state.publicKey = resp.publicKey.toString();
                state.isConnected = true;

                // UI Güncelleme
                els.pubkeyDisplay.innerText = truncateAddress(state.publicKey);
                switchView('wallet');
                showStatus("Bağlantı Başarılı!", "success");

            } catch (err) {
                console.error("Bağlantı Hatası:", err);
                // Kullanıcı reddettiyse (User rejected the request)
                if (err.code === 4001) {
                    showStatus("Bağlantı isteği reddedildi.", "error");
                } else {
                    showStatus(`Hata: ${err.message}`, "error");
                }
            }
        }

        // Bağlantıyı Kesme
        async function disconnectWallet() {
            if (state.provider) {
                try {
                    await state.provider.disconnect();
                } catch (e) { console.warn("Disconnect hatası yoksayıldı", e); }
            }
            // State sıfırlama
            state = { provider: null, publicKey: null, isConnected: false, farcasterUser: state.farcasterUser };
            switchView('connect');
            showStatus("Bağlantı kesildi.");
        }

        // Mesaj İmzalama (Sign Message)
        async function signMessage() {
            if (!state.provider) return;

            try {
                // İmzalanacak mesaj
                const message = `Farcaster Frame Login\nUser: ${state.farcasterUser?.username |

| 'Anon'}\nTimestamp: ${Date.now()}`;
                const encodedMessage = new TextEncoder().encode(message);
                
                showStatus("İmza bekleniyor...");
                
                // Cüzdandan imza iste
                const signedMessage = await state.provider.signMessage(encodedMessage, "utf8");
                
                // İmzayı Base64 formatına çevir (Sunucuya göndermek için ideal format)
                // Saf JS'de Buffer olmadığı için 'btoa' ve 'String.fromCharCode' kullanıyoruz.
                // Not: signedMessage.signature bir Uint8Array döner.
                let signatureBase64 = "";
                if (signedMessage.signature) {
                     signatureBase64 = btoa(String.fromCharCode(...signedMessage.signature));
                } else {
                    // Solflare bazen doğrudan signature array dönebilir
                    signatureBase64 = btoa(String.fromCharCode(...signedMessage));
                }

                console.log("Oluşturulan İmza:", signatureBase64);
                showStatus("Mesaj başarıyla imzalandı! (Konsola bakınız)", "success");
                
            } catch (err) {
                console.error("İmza Hatası:", err);
                showStatus("İmzalama başarısız.", "error");
            }
        }

        // ---------------------------------------------------------
        // 6. Başlatma ve Olay Dinleyicileri (Initialization)
        // ---------------------------------------------------------

        async function init() {
            try {
                // Farcaster SDK Yükleniyor...
                // SDK'nın 'ready' metodunu çağırmak, Farcaster istemcisine 
                // "Ben hazırım, yükleme ekranını kaldır" sinyali gönderir.
                await sdk.actions.ready();

                // Kullanıcı Bağlamını (Context) Çekme
                const context = await sdk.context;
                if (context && context.user) {
                    state.farcasterUser = context.user;
                    els.userContext.innerText = `@${context.user.username}`;
                    console.log("Farcaster Context Yüklendi:", context);
                }

                // Cüzdan otomatik bağlanmayı dene (Eğer daha önce izin verildiyse)
                // 'onlyIfTrusted' parametresi, pop-up açmadan bağlanmayı dener.
                const provider = getSolanaProvider();
                if (provider) {
                    try {
                         // Bu özellik her cüzdanda standart olmayabilir, try-catch içinde deniyoruz.
                         const resp = await provider.connect({ onlyIfTrusted: true });
                         state.provider = provider;
                         state.publicKey = resp.publicKey.toString();
                         state.isConnected = true;
                         els.pubkeyDisplay.innerText = truncateAddress(state.publicKey);
                         switchView('wallet');
                    } catch (e) {
                        // Otomatik bağlantı başarısız, kullanıcı manuel bağlanmalı
                        switchView('connect');
                    }
                } else {
                    switchView('connect');
                }

            } catch (err) {
                console.error("Frame Başlatma Hatası:", err);
                showStatus("Uygulama başlatılamadı.", "error");
                // Hata durumunda bile connect ekranını göster ki kullanıcı tamamen bloke olmasın
                switchView('connect');
            }
        }

        // Event Listener'lar
        els.connectBtn.addEventListener('click', connectWallet);
        els.disconnectBtn.addEventListener('click', disconnectWallet);
        els.signMsgBtn.addEventListener('click', signMessage);

        // Sayfa tamamen yüklendiğinde başlat
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>
</body>
</html>
