<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solarator - Sol Incinerator</title>
    
    <meta property="og:title" content="Solarator" />
    <meta property="og:description" content="Burn empty token accounts, reclaim SOL" />
    <meta property="og:image" content="https://solarator-one.vercel.app/preview.jpg" />
    <meta property="og:type" content="website" />
    
    <meta property="fc:frame" content='{"version": "next", "imageUrl": "https://solarator-one.vercel.app/preview.jpg", "button": {"title": "Launch Solarator", "action": {"type": "launch_frame", "name": "Solarator", "url": "https://solarator-one.vercel.app", "splashImageUrl": "https://solarator-one.vercel.app/preview.jpg", "splashBackgroundColor": "#0a0a0a"}}}' />
    <meta name="fc:miniapp" content="hosted" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a0a; 
            color: white;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .glow-text {
            text-shadow: 0 0 20px rgba(255, 80, 0, 0.5);
        }
        
        .loader {
            border: 3px solid #333;
            border-top: 3px solid #ff4500;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .account-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-item.selected {
            background: rgba(255, 102, 0, 0.2) !important;
            border-color: #ff6600 !important;
        }

        .account-item:active {
            transform: scale(0.98);
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
        }

        .checkbox-custom.checked {
            background: #ff6600;
            border-color: #ff6600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-orange-600 selection:text-white">


    <header class="bg-gradient-to-r from-orange-900 via-red-900 to-black p-4 sm:p-6 rounded-b-3xl shadow-2xl shadow-orange-900/20 relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-20">
            <i class="fa-solid fa-fire text-4xl sm:text-6xl text-orange-500"></i>
        </div>
        
        <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="bg-orange-600 p-2 rounded-lg shadow-lg shadow-orange-500/30">
                    <i class="fa-solid fa-fire-flame-curved text-white text-lg sm:text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-black tracking-tighter glow-text">SOLarator</h1>
                    <p class="text-[10px] sm:text-xs text-orange-200/70">Incinerator & Refund Tool</p>
                </div>
            </div>
            <div id="wallet-status" class="px-2 sm:px-3 py-1 bg-black/40 rounded-full border border-white/10 text-[10px] sm:text-xs text-gray-400">
                <i class="fa-solid fa-wallet mr-1"></i> <span class="hidden sm:inline">Not Connected</span><span class="sm:hidden">-</span>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 sm:p-6 flex flex-col gap-4 sm:gap-6 max-w-md mx-auto w-full">
        
        <div class="glass-panel rounded-2xl p-4 sm:p-6 text-center shadow-lg relative overflow-hidden group">
            <div class="absolute inset-0 bg-gradient-to-b from-orange-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
            
            <h2 class="text-gray-400 text-xs sm:text-sm font-semibold uppercase tracking-widest mb-1">Total Recoverable</h2>
            <div class="flex items-center justify-center gap-2">
                <span id="refund-amount" class="text-4xl sm:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">0.00</span>
                <span class="text-lg sm:text-xl font-bold text-orange-500">SOL</span>
            </div>
            
            <div id="action-area" class="mt-4 sm:mt-6">
                <button onclick="connectWallet()" id="connect-btn" class="w-full py-3 sm:py-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 border border-white/5 text-sm sm:text-base shadow-lg">
                    <i class="fa-solid fa-wallet"></i> Connect Wallet
                </button>
            </div>
            
            <div id="status-msg" class="mt-3 text-xs text-gray-500 h-4">Connect your wallet to start</div>
        </div>

        <div id="account-list-container" class="hidden flex-col gap-3">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-xs text-gray-500 font-bold uppercase tracking-wider">Burnable Accounts</h3>
                <div class="flex items-center gap-2">
                    <span id="selected-badge" class="bg-orange-600 text-white text-[10px] px-2 py-0.5 rounded font-bold">0 Selected</span>
                    <span id="count-badge" class="bg-orange-900/50 text-orange-400 text-[10px] px-2 py-0.5 rounded border border-orange-500/20">0 Total</span>
                </div>
            </div>
            
            <button onclick="selectAll()" class="text-xs text-orange-400 underline self-start px-1">Select All</button>
            
            <div id="accounts-wrapper" class="max-h-72 overflow-y-auto space-y-2 pr-1">
            </div>

            <button onclick="burnSelected()" id="burn-btn" disabled class="w-full py-4 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 disabled:from-gray-700 disabled:to-gray-800 text-white rounded-xl font-black shadow-lg disabled:shadow-none flex items-center justify-center gap-2 text-base transition-all">
                <i class="fa-solid fa-fire"></i> BURN SELECTED ACCOUNTS
            </button>
        </div>

    </main>

    <footer class="p-3 sm:p-4 text-center text-[9px] sm:text-[10px] text-gray-600 border-t border-white/5 bg-black/50 backdrop-blur">
        <p>Powered by Helius RPC & Solana Web3</p>
    </footer>

    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';

        // --- YAPILAN MÄ°NÄ°MAL DÃœZELTME: FonksiyonlarÄ± Window'a Ata ---
        // Bu sayede HTML'deki onclick="..." Ã§alÄ±ÅŸÄ±r.
        window.connectWallet = connectWallet;
        window.selectAll = selectAll;
        window.burnSelected = burnSelected;
        window.toggleSelect = toggleSelect; // Bunu da ekledim

        const HELIUS_RPC = "https://mainnet.helius-rpc.com/?api-key=60ab6dbf-aa02-4ff8-9e12-b26abdcd40cc";
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
        
        let connection;
        let userPublicKey = null;
        let emptyAccounts = [];
        let selectedAccounts = new Set();
        let isInFrame = false;

        window.addEventListener('load', async () => {
            connection = new solanaWeb3.Connection(HELIUS_RPC);
            
            try {
                // SDK Context KontrolÃ¼
                const context = await sdk.context;
                if (context) {
                    console.log("âœ… Farcaster Environment Detected");
                    isInFrame = true;
                    sdk.actions.ready();
                }

        async function connectWallet() {
            const btn = document.getElementById('connect-btn');
            const status = document.getElementById('status-msg');

            try {
                btn.innerHTML = '<div class="loader"></div><span class="ml-2">Connecting...</span>';
                btn.disabled = true;
                status.innerText = "Opening Solana wallet...";

                // Ã–nce Farcaster Wallet, yoksa Window Solana
                let provider = null;
                if (isInFrame && sdk && sdk.wallet) {
                    provider = sdk.wallet.ethProvider; 
                } else {
                    provider = window.solana;
                }

                if (!provider) {
                    throw new Error("No Solana wallet found. Please install Phantom or use Farcaster.");
                }

                const response = await provider.connect();
                userPublicKey = response.publicKey;

                document.getElementById('wallet-status').innerHTML = 
                    `<i class="fa-solid fa-link text-green-500"></i> ${userPublicKey.toString().slice(0,4)}...${userPublicKey.toString().slice(-4)}`;
                
                status.innerText = "Wallet connected! Scanning...";
                await scanAccounts();

            } catch (err) {
                console.error("Connection error:", err);
                status.innerText = "Connection failed: " + err.message;
                btn.innerHTML = '<i class="fa-solid fa-wallet"></i> Connect Wallet';
                btn.disabled = false;
            }
        }

        async function scanAccounts() {
            const status = document.getElementById('status-msg');

            try {
                status.innerText = "Fetching token accounts...";

                const accounts = await connection.getParsedTokenAccountsByOwner(userPublicKey, {
                    programId: TOKEN_PROGRAM_ID
                });

                emptyAccounts = accounts.value.filter(acc => {
                    const amount = acc.account.data.parsed.info.tokenAmount.uiAmount;
                    return amount === 0;
                }).map(acc => ({
                    pubkey: acc.pubkey,
                    mint: acc.account.data.parsed.info.mint,
                    rentExemptReserve: acc.account.lamports
                }));

                if (emptyAccounts.length === 0) {
                    status.innerText = "âœ… No empty accounts found!";
                    document.getElementById('action-area').innerHTML = `
                        <div class="py-4 bg-green-900/20 text-green-400 rounded-xl text-center border border-green-500/20">
                            <i class="fa-solid fa-check-circle"></i> Wallet is Clean!
                        </div>
                    `;
                } else {
                    status.innerText = `Found ${emptyAccounts.length} empty accounts!`;
                    document.getElementById('account-list-container').classList.remove('hidden');
                    document.getElementById('account-list-container').classList.add('flex');
                    document.getElementById('action-area').style.display = 'none';
                    renderAccounts();
                }

            } catch (err) {
                console.error("Scan error:", err);
                status.innerText = "Scan failed: " + err.message;
            }
        }

        function renderAccounts() {
            const wrapper = document.getElementById('accounts-wrapper');
            const badge = document.getElementById('count-badge');
            
            badge.innerText = `${emptyAccounts.length} Total`;
            wrapper.innerHTML = "";

            emptyAccounts.forEach((acc, index) => {
                const item = document.createElement('div');
                item.className = "account-item flex items-center justify-between p-3 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition";
                
                // Onclick HTML'den Ã§aÄŸrÄ±lacak
                item.onclick = () => window.toggleSelect(index);
                
                if (selectedAccounts.has(index)) {
                     item.classList.add('selected');
                }

                const solReclaim = (acc.rentExemptReserve / 1e9).toFixed(6);

                item.innerHTML = `
                    <div class="flex items-center gap-3 pointer-events-none">
                        <div class="checkbox-custom ${selectedAccounts.has(index) ? 'checked' : ''}">
                            <i class="fa-solid fa-check text-white text-xs" style="${selectedAccounts.has(index) ? 'display:block' : 'display:none'}"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] text-gray-300 font-mono tracking-wide">${acc.pubkey.toString().slice(0, 16)}...</span>
                            <span class="text-[9px] text-gray-500">Mint: ${acc.mint.slice(0,8)}...</span>
                        </div>
                    </div>
                    <div class="text-[11px] text-orange-400 font-mono font-bold">+${solReclaim} SOL</div>
                `;
                wrapper.appendChild(item);
            });
            updateSelectionUI();
        }

        function toggleSelect(index) {
            if (selectedAccounts.has(index)) {
                selectedAccounts.delete(index);
            } else {
                selectedAccounts.add(index);
            }
            renderAccounts();
        }

        function selectAll() {
            selectedAccounts.clear();
            emptyAccounts.forEach((_, index) => {
                selectedAccounts.add(index);
            });
            renderAccounts();
        }

        function updateSelectionUI() {
            const selectedBadge = document.getElementById('selected-badge');
            const burnBtn = document.getElementById('burn-btn');
            const refundAmount = document.getElementById('refund-amount');

            selectedBadge.innerText = `${selectedAccounts.size} Selected`;
            burnBtn.disabled = selectedAccounts.size === 0;

            let totalSol = 0;
            selectedAccounts.forEach(index => {
                totalSol += emptyAccounts[index].rentExemptReserve / 1e9;
            });
            refundAmount.innerText = totalSol.toFixed(4);
        }

        async function burnSelected() {
            const burnBtn = document.getElementById('burn-btn');
            const status = document.getElementById('status-msg');

            if (selectedAccounts.size === 0) return;

            try {
                burnBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Creating Transaction...</span>';
                burnBtn.disabled = true;
                status.innerText = "Building burn transaction...";

                const transaction = new solanaWeb3.Transaction();
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = userPublicKey;

                selectedAccounts.forEach(index => {
                    const acc = emptyAccounts[index];
                    transaction.add(new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: acc.pubkey, isSigner: false, isWritable: true },
                            { pubkey: userPublicKey, isSigner: false, isWritable: true },
                            { pubkey: userPublicKey, isSigner: true, isWritable: false }
                        ],
                        programId: TOKEN_PROGRAM_ID,
                        data: Uint8Array.of(9)
                    }));
                });

                // Provider seÃ§imi
                let provider = null;
                if (isInFrame && sdk && sdk.wallet) {
                    provider = sdk.wallet.ethProvider; 
                } else {
                    provider = window.solana;
                }

                status.innerText = `Waiting for approval...`;
                const { signature } = await provider.signAndSendTransaction(transaction);
                
                status.innerHTML = `âœ… Success! <a href="https://solscan.io/tx/${signature}" target="_blank" class="underline text-orange-400">View TX</a>`;
                
                // Temizlik
                emptyAccounts = emptyAccounts.filter((_, index) => !selectedAccounts.has(index));
                selectedAccounts.clear();

                if (emptyAccounts.length === 0) {
                    document.getElementById('account-list-container').innerHTML = `
                        <div class="py-8 text-center">
                            <div class="text-6xl mb-4">ðŸ”¥</div>
                            <h3 class="text-xl font-black text-orange-400">All Accounts Burned!</h3>
                            <p class="text-sm text-gray-400 mt-2">SOL has been reclaimed to your wallet</p>
                        </div>
                    `;
                } else {
                    renderAccounts();
                    updateSelectionUI();
                }
                
                burnBtn.innerHTML = '<i class="fa-solid fa-fire"></i> BURN SELECTED ACCOUNTS';
                burnBtn.disabled = false;

            } catch (err) {
                console.error("Burn error:", err);
                status.innerText = "Transaction failed: " + err.message;
                burnBtn.innerHTML = '<i class="fa-solid fa-fire"></i> BURN SELECTED ACCOUNTS';
                burnBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
